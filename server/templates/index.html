{% macro render_node(node) %}
<div class="node" data-index="{{node.index}}">
  <div class="title">{{node.value}}</div>
  {% if node.children|length > 0 %}
    <div class="children">
      {% for child in node.children %}
        {{ render_node(child) }}
      {% endfor %}
    </div>
  {% endif %}
</div>
{%- endmacro %}

<!DOCTYPE html>
<html>
  <head>
    <title> QS Cache </title>
    <style>
      html, body {
        height: 100%;
      }
      body {
        display: grid;
        grid-template-columns: 45% 10% 45%;
        grid-template-rows: 1em 10fr 1fr;
        row-gap: 1em;
      }
      .error {
        grid-row: 3;
        grid-column-start: 1;
        grid-column-end: span 3;
        color: red;
      }
      .hidden {
        display: none;
      }
      .selected {
        background-color:wheat;
      }
      .node {
        /* border: 1px solid red; */
      }
      .children {
        margin-left: 1.5em;
        /* border: 1px solid black; */
      }
      .db {
        border: 1px solid black;
        grid-column: 3;
        grid-row: 2/2;
      }
      .cache {
        grid-column: 1;
        grid-row: 2/2;
        border: 1px solid black;
      }
      .controls {
        grid-column: 2;
        grid-row: 2/2;
        display: flex;
        flex-direction: column;
        margin: 0 .5em;
      }
      .alter-control {
        grid-row: 1;

      }
    </style>
  </head>
  <body>
    <div class="alter-control">
      <input id="alter-value" type="text" value="">
    </div>
    <div class="cache">
      {% for node in cache %}
          {{ render_node(node) }}
      {% endfor %}
    </div>
    <div class="controls">
      <button class="insert">+</button>
      <button class="alter">a</button>
      <button class="delete">-</button>
      <button class="apply">apply</button>
      <button class="load"><<<</button>
      <button class="reset">reset</button>
    </div>
    <div class="db">
      {% for node in db %}
          {{ render_node(node) }}
      {% endfor %}
    </div>
    <div class="error"></div>
    <script>
      window.storage = {
        db_selected_index: null,
        cache_selected_index: null,
      }
      function post(uri, data) {
        let options = {method:"POST", headers: {"Content-Type": "application/json"}}
        if (data) {
          options.body = JSON.stringify(data)
        }
        return fetch(uri, options)
      }
      function patch(uri, data) {
        let options = {method:"PATCH", headers: {"Content-Type": "application/json"}}
        if (data) {
          options.body = JSON.stringify(data)
        }
        return fetch(uri, options)
      }

      function render_error(error) {
        let error_elem = document.querySelector('.error')
        if (error.message) {
          error_elem.textContent = error.message
        }
        else if (error.error) {
          error_elem.textContent = error.error
        }
        else if (error.detail) {
          error_elem.textContent = JSON.stringify(error.detail)
        }
      }

      function clear_error() {
        let error_elem = document.querySelector('.error')
        error_elem.textContent = ""
      }

      function dbNodeClicked(event, node_idx) {
          event.preventDefault()
          event.stopPropagation()

          let selected_item = document.querySelector('.db .title.selected')
          if (selected_item) {
            selected_item.classList.remove("selected")
          }
          let node_elem = document.querySelector(`.db [data-index='${node_idx}'] > .title`)
          node_elem.classList.add("selected")

          storage.db_selected_index = node_idx


      }
      function cacheNodeClicked(event, node_idx) {
          event.preventDefault()
          event.stopPropagation()

          let selected_item = document.querySelector('.cache .title.selected')
          if (selected_item) {
            selected_item.classList.remove("selected")
          }
          let node_elem = document.querySelector(`.cache [data-index='${node_idx}'] > .title`)
          node_elem.classList.add("selected")

          document.querySelector('#alter-value').value = node_elem.textContent

          storage.cache_selected_index = node_idx
      }

      async function load(event) {
        try {
          // NOTE: loading nodes changes state of server. SHOULD be unsefa method
          let resp = await fetch(`/cache?index=${storage.db_selected_index}`)
          let data = await resp.json()
          if (resp.status != 200) {
            render_error(data)
          }
          else {
            window.location.reload()

          }
        } catch(e) {
          render_error(e)
        }

      }
      async function alter() {
        const new_value = document.querySelector('#alter-value').value
        const index = storage.cache_selected_index
        console.debug("start alter api")
        try {
          let resp = await patch("/cache", {value: new_value, index})
          let data = await resp.json()
          if (resp.status != 200) {
            render_error(data)
          }
          else {
            window.location.reload()
          }
        } catch (e) {
          render_error(e)
        }
      }

      async function apply() {
        try {
          let resp = await post("/cache/apply")
          let data = await resp.json()
          if (resp.status != 200) {
            render_error(data)
          }
          else {
            window.location.reload()
          }
        } catch (e) {
          render_error(e)
        }
      }
      // init
      (function(){
        // bind onclick function
        [...document.querySelectorAll(".db .node")].map(node => {
          node.onclick = (e) => dbNodeClicked(e, node.dataset["index"])
        });

        [...document.querySelectorAll(".cache .node")].map(node => {
          node.onclick = (e) => cacheNodeClicked(e, node.dataset["index"])
        });

        document.querySelector('.controls .load').onclick = load
        document.querySelector('.controls .alter').onclick = alter
        document.querySelector('.controls .apply').onclick = apply

      })()
    </script>
  </body>
</html>
